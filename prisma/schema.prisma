// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// ==============================================
// P0.1 - INSCRIPTION & VALIDATION PROVIDER
// ==============================================

/// Table centrale utilisateurs (clients + providers + admins)
model User {
  id              Int       @id @default(autoincrement())
  phone           String    @unique @db.VarChar(20)
  email           String?   @unique @db.VarChar(191)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  phoneVerifiedAt DateTime? @map("phone_verified_at")
  emailVerifiedAt DateTime? @map("email_verified_at")
  isActive        Boolean   @default(true) @map("is_active")
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  roles                    UserRole[]
  clientProfile            ClientProfile?
  providerProfile          ProviderProfile?
  refreshTokens            RefreshToken[]
  appointmentsAsClient     Appointment[]             @relation("ClientAppointments")
  confirmedAppointments    AppointmentConfirmation[]
  cancelledAppointments    AppointmentCancellation[]
  clientReputation         ClientReputation?
  cancellationRequests     CancellationRequest[]     @relation("CancellationRequester")
  cancellationResponses    CancellationRequest[]     @relation("CancellationResponder")
  disputesOpened           Dispute[]                 @relation("DisputeOpener")
  disputesAgainst          Dispute[]                 @relation("DisputeDefendant")
  disputesResolved         Dispute[]                 @relation("DisputeResolver")
  reviews                  Review[]
  favorites                Favorite[]

  @@index([phone])
  @@index([email])
  @@index([isActive, deletedAt])
  @@map("users")
}

/// Codes OTP (One-Time Password) - Usage universel
/// Types: phone_verification, email_verification, password_reset, mfa, etc.
model Otp {
  id         Int       @id @default(autoincrement())
  identifier String    @db.VarChar(100) // phone, email, userId, etc.
  code       String    @db.VarChar(10)
  type       String    @db.VarChar(30) // phone_verification, email_verification, password_reset, mfa
  expiresAt  DateTime  @map("expires_at")
  attempts   Int       @default(0)
  isUsed     Boolean   @default(false) @map("is_used")
  usedAt     DateTime? @map("used_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  @@unique([identifier, type])
  @@index([identifier, type])
  @@index([expiresAt])
  @@index([isUsed])
  @@map("otps")
}

/// Catégories de services (OCP)
model ServiceCategory {
  id           Int      @id @default(autoincrement())
  code         String   @unique @db.VarChar(50)
  icon         String?  @db.VarChar(50)
  parentId     Int?     @map("parent_id")
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  parent              ServiceCategory?             @relation("SubCategories", fields: [parentId], references: [id], onDelete: SetNull)
  children            ServiceCategory[]            @relation("SubCategories")
  translations        ServiceCategoryTranslation[]
  services            Service[]
  providerSpecialties ProviderSpecialty[]

  @@index([code])
  @@index([parentId])
  @@index([isActive, displayOrder])
  @@map("service_categories")
}

/// Traductions des catégories de service
model ServiceCategoryTranslation {
  id          Int     @id @default(autoincrement())
  categoryId  Int     @map("category_id")
  locale      String  @db.VarChar(5)
  name        String  @db.VarChar(100)
  description String? @db.Text

  // Relations
  category ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, locale], name: "unique_translation")
  @@index([locale])
  @@map("service_category_translations")
}

/// Services proposés par les providers
model Service {
  id          Int       @id @default(autoincrement())
  providerId  Int       @map("provider_id")
  categoryId  Int       @map("category_id")
  name        String    @db.VarChar(255)
  description String?   @db.Text
  price       Decimal   @db.Decimal(10, 2)
  duration    Int // minutes
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  provider     ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  category     ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  appointments Appointment[]

  @@index([providerId, isActive])
  @@index([categoryId, isActive])
  @@index([isActive, deletedAt])
  @@map("services")
}

/// Spécialités des providers
model ProviderSpecialty {
  id              Int       @id @default(autoincrement())
  providerId      Int       @map("provider_id")
  categoryId      Int       @map("category_id")
  yearsExperience Int       @default(0) @map("years_experience")
  isPrimary       Boolean   @default(false) @map("is_primary")
  createdAt       DateTime  @default(now()) @map("created_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  category ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([providerId, categoryId])
  @@index([categoryId, isPrimary])
  @@index([providerId])
  @@map("provider_specialties")
}

/// Rôles système (OCP)
model Role {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(50)
  name        String   @db.VarChar(100)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  userRoles UserRole[]

  @@index([code])
  @@index([isActive])
  @@map("roles")
}

/// Attribution multi-rôles
model UserRole {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Restrict)

  @@unique([userId, roleId])
  @@index([userId, roleId])
  @@map("user_roles")
}

/// Refresh tokens JWT (Sécurité)
model RefreshToken {
  id         Int       @id @default(autoincrement())
  tokenHash  String    @unique @map("token_hash") @db.VarChar(64) // SHA-256 hash du token
  userId     Int       @map("user_id")
  deviceInfo String?   @map("device_info") @db.VarChar(255)
  ipAddress  String?   @map("ip_address") @db.VarChar(45)
  expiresAt  DateTime  @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime  @default(now()) @map("last_used_at")
  isRevoked  Boolean   @default(false) @map("is_revoked")
  revokedAt  DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@index([expiresAt])
  @@index([isRevoked, expiresAt])
  @@map("refresh_tokens")
}

/// Profils clients (LSP)
model ClientProfile {
  id          Int       @id @default(autoincrement())
  userId      Int       @unique @map("user_id")
  firstName   String?   @map("first_name") @db.VarChar(100)
  lastName    String?   @map("last_name") @db.VarChar(100)
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  preferences Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("client_profiles")
}

/// Types de business pour les providers
model BusinessType {
  id           Int      @id @default(autoincrement())
  code         String   @unique @db.VarChar(50)
  icon         String?  @db.VarChar(50)
  isActive     Boolean  @default(true) @map("is_active")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  translations BusinessTypeTranslation[]
  providers    ProviderProfile[]

  @@index([code])
  @@index([isActive, displayOrder])
  @@map("business_types")
}

/// Traductions des types de business
model BusinessTypeTranslation {
  id             Int     @id @default(autoincrement())
  businessTypeId Int     @map("business_type_id")
  locale         String  @db.VarChar(5)
  label          String  @db.VarChar(100)
  description    String? @db.Text

  // Relations
  businessType BusinessType @relation(fields: [businessTypeId], references: [id], onDelete: Cascade)

  @@unique([businessTypeId, locale], name: "unique_translation")
  @@index([locale])
  @@map("business_type_translations")
}

/// Profils prestataires (SRP) - P0.1
model ProviderProfile {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique @map("user_id")
  businessTypeId  Int?      @map("business_type_id")
  businessName    String?   @map("business_name") @db.VarChar(255)
  bio             String?   @db.Text
  yearsExperience Int       @default(0) @map("years_experience")
  address         String?   @db.Text
  city            String    @db.VarChar(100)
  neighborhood    String?   @db.VarChar(100)
  latitude        Decimal?  @db.Decimal(10, 8)
  longitude       Decimal?  @db.Decimal(11, 8)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  user                   User                            @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessType           BusinessType?                   @relation(fields: [businessTypeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  services               Service[]
  specialties            ProviderSpecialty[]
  availabilities         ProviderAvailability[]
  serviceSettings        ProviderServiceSettings?
  verification           ProviderVerification?
  statistics             ProviderStatistics?
  registrationDocuments  ProviderRegistrationDocument[]
  appointments           Appointment[]
  reputation             ProviderReputation?
  reviews                Review[]
  favoritedBy            Favorite[]

  @@index([userId])
  @@index([businessTypeId])
  @@index([city, neighborhood])
  @@index([latitude, longitude])
  @@map("provider_profiles")
}

/// Documents inscription provider (P0.1)
model ProviderRegistrationDocument {
  id         Int      @id @default(autoincrement())
  providerId Int      @map("provider_id")
  type       String   @db.VarChar(50) // 'identity_card', 'diploma', 'portfolio'
  fileUrl    String   @map("file_url") @db.VarChar(500)
  fileName   String   @map("file_name") @db.VarChar(255)
  mimeType   String   @map("mime_type") @db.VarChar(100)
  fileSize   Int      @map("file_size") // bytes
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  // Relations
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId, type])
  @@map("provider_registration_documents")
}

/// Disponibilités provider - approche flexible par date (SRP)
/// Chaque entrée représente un créneau de disponibilité pour une date précise
model ProviderAvailability {
  id          Int      @id @default(autoincrement())
  providerId  Int      @map("provider_id")
  date        DateTime @db.Date // Date spécifique (YYYY-MM-DD)
  startTime   DateTime @map("start_time") @db.Time(0) // Format HH:mm
  endTime     DateTime @map("end_time") @db.Time(0) // Format HH:mm
  isAvailable Boolean  @default(true) @map("is_available") // true=disponible, false=bloqué
  reason      String?  @db.VarChar(255) // Raison optionnelle (congé, formation, etc.)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Contrainte: un seul créneau par provider/date/heure de début
  @@unique([providerId, date, startTime])
  @@index([providerId, date])
  @@index([date, isAvailable])
  @@map("provider_availabilities")
}

/// Configuration services provider (SRP)
model ProviderServiceSettings {
  id                  Int      @id @default(autoincrement())
  providerId          Int      @unique @map("provider_id")
  offersHomeService   Boolean  @default(false) @map("offers_home_service")
  homeServiceRadiusKm Int      @default(0) @map("home_service_radius_km")
  autoAcceptBookings  Boolean  @default(false) @map("auto_accept_bookings")
  bookingAdvanceDays  Int      @default(30) @map("booking_advance_days")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@map("provider_service_settings")
}

/// Workflow validation provider (SRP) - P0.1
model ProviderVerification {
  id                Int       @id @default(autoincrement())
  providerId        Int       @unique @map("provider_id")
  status            String    @default("pending") @db.VarChar(50) // pending, approved, rejected, suspended
  verifiedByUserId  Int?      @map("verified_by_user_id")
  verifiedAt        DateTime? @map("verified_at")
  rejectionReason   String?   @map("rejection_reason") @db.Text
  phoneVerified     Boolean   @default(false) @map("phone_verified")
  identityVerified  Boolean   @default(false) @map("identity_verified")
  portfolioVerified Boolean   @default(false) @map("portfolio_verified")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([status])
  @@map("provider_verifications")
}

/// Statistiques provider (SRP)
model ProviderStatistics {
  providerId       Int      @id @map("provider_id")
  averageRating    Decimal  @default(0.00) @map("average_rating") @db.Decimal(3, 2)
  totalReviews     Int      @default(0) @map("total_reviews")
  totalBookings    Int      @default(0) @map("total_bookings")
  totalCompleted   Int      @default(0) @map("total_completed")
  totalCancelled   Int      @default(0) @map("total_cancelled")
  lastCalculatedAt DateTime @default(now()) @updatedAt @map("last_calculated_at")

  // Relations
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([averageRating])
  @@map("provider_statistics")
}

/// Réservations (ISP)
/// Statuts: pending, confirmed, reconfirmed, unconfirmed, in_progress, completed, cancelled, cancelled_late, no_show, provider_absent, disputed
model Appointment {
  id                  Int       @id @default(autoincrement())
  clientId            Int       @map("client_id")
  providerId          Int       @map("provider_id")
  serviceId           Int       @map("service_id")
  scheduledAt         DateTime  @map("scheduled_at") @db.Timestamp(0)
  durationMinutes     Int       @map("duration_minutes")
  endAt               DateTime? @map("end_at") @db.Timestamp(0)
  status              String    @default("pending") @db.VarChar(50)
  priceFcfa           Int       @map("price_fcfa")
  depositFcfa         Int       @default(0) @map("deposit_fcfa")
  confirmationCode    String?   @map("confirmation_code") @db.VarChar(6)
  reconfirmedAt       DateTime? @map("reconfirmed_at") @db.Timestamp(0)
  clientArrivedAt     DateTime? @map("client_arrived_at") @db.Timestamp(0)
  clientLateMinutes   Int?      @map("client_late_minutes")
  providerLateMinutes Int?      @map("provider_late_minutes")
  startedAt           DateTime? @map("started_at") @db.Timestamp(0)
  completedAt         DateTime? @map("completed_at") @db.Timestamp(0)
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamp(0)

  // Relations
  client              User                     @relation("ClientAppointments", fields: [clientId], references: [id], onDelete: Restrict)
  provider            ProviderProfile          @relation(fields: [providerId], references: [id], onDelete: Restrict)
  service             Service                  @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  confirmation        AppointmentConfirmation?
  cancellation        AppointmentCancellation?
  cancellationRequest CancellationRequest?
  disputes            Dispute[]
  review              Review?

  @@unique([providerId, scheduledAt], name: "unique_provider_slot")
  @@index([clientId, status])
  @@index([providerId, status])
  @@index([scheduledAt])
  @@index([status])
  @@map("appointments")
}

/// Confirmations de réservation (ISP)
model AppointmentConfirmation {
  appointmentId     Int      @id @map("appointment_id")
  confirmedAt       DateTime @map("confirmed_at") @db.Timestamp(0)
  confirmedByUserId Int      @map("confirmed_by_user_id")

  // Relations
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  confirmedBy User        @relation(fields: [confirmedByUserId], references: [id], onDelete: Restrict)

  @@map("appointment_confirmations")
}

/// Annulations de réservation (ISP)
model AppointmentCancellation {
  appointmentId      Int      @id @map("appointment_id")
  cancelledAt        DateTime @map("cancelled_at") @db.Timestamp(0)
  cancelledByUserId  Int      @map("cancelled_by_user_id")
  cancellationReason String?  @map("cancellation_reason") @db.Text
  cancellationType   String?  @map("cancellation_type") @db.VarChar(50) // client, provider, admin, system

  // Relations
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  cancelledBy User        @relation(fields: [cancelledByUserId], references: [id], onDelete: Restrict)

  @@map("appointment_cancellations")
}

/// Score de réputation client
model ClientReputation {
  id                 Int       @id @default(autoincrement())
  clientId           Int       @unique @map("client_id")
  score              Int       @default(50)
  totalAppointments  Int       @default(0) @map("total_appointments")
  completedCount     Int       @default(0) @map("completed_count")
  noShowCount        Int       @default(0) @map("no_show_count")
  lateCount          Int       @default(0) @map("late_count")
  cancelledLateCount Int       @default(0) @map("cancelled_late_count")
  disputesWonCount   Int       @default(0) @map("disputes_won_count")
  disputesLostCount  Int       @default(0) @map("disputes_lost_count")
  isSuspended        Boolean   @default(false) @map("is_suspended")
  suspendedUntil     DateTime? @map("suspended_until")
  suspensionReason   String?   @map("suspension_reason") @db.Text
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  client User @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_reputations")
}

/// Score de réputation provider
model ProviderReputation {
  id                 Int       @id @default(autoincrement())
  providerId         Int       @unique @map("provider_id")
  score              Int       @default(50)
  totalAppointments  Int       @default(0) @map("total_appointments")
  completedCount     Int       @default(0) @map("completed_count")
  noShowCount        Int       @default(0) @map("no_show_count")
  absentCount        Int       @default(0) @map("absent_count")
  lateCount          Int       @default(0) @map("late_count")
  cancelledLateCount Int       @default(0) @map("cancelled_late_count")
  disputesWonCount   Int       @default(0) @map("disputes_won_count")
  disputesLostCount  Int       @default(0) @map("disputes_lost_count")
  isSuspended        Boolean   @default(false) @map("is_suspended")
  suspendedUntil     DateTime? @map("suspended_until")
  suspensionReason   String?   @map("suspension_reason") @db.Text
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_reputations")
}

/// Demande d'annulation exceptionnelle (< 24h)
model CancellationRequest {
  id                Int       @id @default(autoincrement())
  appointmentId     Int       @unique @map("appointment_id")
  requestedByUserId Int       @map("requested_by_user_id")
  requestedByRole   String    @map("requested_by_role") @db.VarChar(20) // client, provider
  reasonType        String    @map("reason_type") @db.VarChar(50) // medical, family, professional, technical, other
  reasonText        String?   @map("reason_text") @db.Text
  proofUrl          String?   @map("proof_url") @db.VarChar(500)
  status            String    @default("pending") @db.VarChar(20) // pending, accepted, rejected, expired
  respondedByUserId Int?      @map("responded_by_user_id")
  respondedAt       DateTime? @map("responded_at")
  responseNote      String?   @map("response_note") @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  requestedBy User        @relation("CancellationRequester", fields: [requestedByUserId], references: [id])
  respondedBy User?       @relation("CancellationResponder", fields: [respondedByUserId], references: [id])

  @@map("cancellation_requests")
}

/// Litige entre client et provider
model Dispute {
  id                Int       @id @default(autoincrement())
  appointmentId     Int       @map("appointment_id")
  openedByUserId    Int       @map("opened_by_user_id")
  againstUserId     Int       @map("against_user_id")
  type              String    @db.VarChar(50) // no_show_contested, provider_absent_contested, quality_issue, partial_service, late_cancellation_rejected, other
  description       String    @db.Text
  proofUrls         Json?     @map("proof_urls")
  status            String    @default("open") @db.VarChar(20) // open, responded, escalated, resolved, closed
  responseText      String?   @map("response_text") @db.Text
  respondedAt       DateTime? @map("responded_at")
  resolvedByAdminId Int?      @map("resolved_by_admin_id")
  resolution        String?   @db.VarChar(50) // in_favor_of_opener, in_favor_of_respondent, mutual_fault, dismissed
  resolutionNote    String?   @map("resolution_note") @db.Text
  resolvedAt        DateTime? @map("resolved_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  appointment     Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  openedBy        User        @relation("DisputeOpener", fields: [openedByUserId], references: [id])
  againstUser     User        @relation("DisputeDefendant", fields: [againstUserId], references: [id])
  resolvedByAdmin User?       @relation("DisputeResolver", fields: [resolvedByAdminId], references: [id])

  @@index([appointmentId])
  @@index([status])
  @@map("disputes")
}

/// Avis client sur provider
model Review {
  id               Int       @id @default(autoincrement())
  appointmentId    Int       @unique @map("appointment_id")
  clientId         Int       @map("client_id")
  providerId       Int       @map("provider_id")
  rating           Int       // 1-5
  comment          String?   @db.Text
  providerResponse String?   @map("provider_response") @db.Text
  respondedAt      DateTime? @map("responded_at")
  isVisible        Boolean   @default(false) @map("is_visible")
  isReported       Boolean   @default(false) @map("is_reported")
  reportReason     String?   @map("report_reason") @db.Text
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  appointment Appointment     @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  client      User            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId, isVisible])
  @@index([clientId])
  @@map("reviews")
}

/// Favoris client
model Favorite {
  id         Int      @id @default(autoincrement())
  clientId   Int      @map("client_id")
  providerId Int      @map("provider_id")
  createdAt  DateTime @default(now()) @map("created_at")

  client   User            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([clientId, providerId])
  @@map("favorites")
}
